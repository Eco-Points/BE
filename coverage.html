
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>service: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">eco_points/internal/features/excelize/service/service.go (82.4%)</option>
				
				<option value="file1">eco_points/internal/features/exchanges/service/service.go (100.0%)</option>
				
				<option value="file2">eco_points/internal/features/feedbacks/service/service.go (100.0%)</option>
				
				<option value="file3">eco_points/internal/features/rewards/service/service.go (94.9%)</option>
				
				<option value="file4">eco_points/internal/features/users/service/service.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package service

import (
        "eco_points/internal/features/excelize"
        "fmt"
        "log"
        "os"
)

type excelMake struct {
        qry excelize.QueryMakeExcelInterface
}

func NewExcelMake(q excelize.QueryMakeExcelInterface) excelize.ServiceMakeExcelInterface <span class="cov8" title="1">{
        return &amp;excelMake{
                qry: q,
        }
}</span>

func (s *excelMake) MakeExcel(date string, table string, userid uint, isVerif bool, limit uint) (string, error) <span class="cov8" title="1">{
        name, link, err := s.qry.MakeExcelFromDeposit(table, date, userid, isVerif, limit)
        if err != nil </span><span class="cov8" title="1">{
                log.Println("error from service ", err)
                if name != "" </span><span class="cov0" title="0">{
                        if err := s.DeleteFile(fmt.Sprintf("./%s", name)); err != nil </span><span class="cov0" title="0">{
                                log.Println("Error deleting file: ", err)
                        }</span>
                }
                <span class="cov8" title="1">return "", err</span>
        }

        <span class="cov8" title="1">if name != "" </span><span class="cov8" title="1">{

                if err := s.DeleteFile(fmt.Sprintf("./%s", name)); err != nil </span><span class="cov8" title="1">{
                        log.Println("Error deleting file: ", err)
                }</span>
        }
        <span class="cov8" title="1">return link, nil</span>
}

func (s *excelMake) DeleteFile(filePath string) error <span class="cov8" title="1">{
        err := os.Remove(filePath)
        if err != nil </span><span class="cov8" title="1">{
                log.Printf("Failed to delete file %s: %v\n", filePath, err)
                return err
        }</span>
        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package service

import (
        "eco_points/internal/features/exchanges"
        "errors"
        "log"
)

type ExchangeServices struct {
        qry exchanges.ExQuery
}

func NewExchangeService(q exchanges.ExQuery) exchanges.ExServices <span class="cov8" title="1">{
        return &amp;ExchangeServices{
                qry: q,
        }
}</span>

func (es *ExchangeServices) AddExchange(newExchange exchanges.Exchange) error <span class="cov8" title="1">{
        err := es.qry.AddExchange(newExchange)
        if err != nil </span><span class="cov8" title="1">{
                return errors.New("failed to create exchange")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (es *ExchangeServices) GetExchangeHistory(userid uint, isAdmin bool, limit uint) ([]exchanges.ListExchangeInterface, error) <span class="cov8" title="1">{
        result, err := es.qry.GetExchangeHistory(userid, isAdmin, limit)
        if err != nil </span><span class="cov8" title="1">{
                log.Println("error on query", err)
                return []exchanges.ListExchangeInterface{}, err

        }</span>
        <span class="cov8" title="1">return result, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package service

import (
        "eco_points/internal/features/feedbacks"
        "errors"
)

type FeedbackServices struct {
        qry feedbacks.FQuery
}

func NewFeedbackService(q feedbacks.FQuery) feedbacks.FServices <span class="cov8" title="1">{
        return &amp;FeedbackServices{
                qry: q,
        }
}</span>

func (fs *FeedbackServices) AddFeedback(newFeedback feedbacks.Feedback) error <span class="cov8" title="1">{
        err := fs.qry.AddFeedback(newFeedback)
        if err != nil </span><span class="cov8" title="1">{
                return errors.New("terjadi kesalahan pada server saat menambahkan feedback")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (fs *FeedbackServices) UpdateFeedback(feedbackID uint, updatedFeedback feedbacks.Feedback) error <span class="cov8" title="1">{
        err := fs.qry.UpdateFeedback(feedbackID, updatedFeedback)
        if err != nil </span><span class="cov8" title="1">{
                return errors.New("terjadi kesalahan pada server saat memperbarui feedback")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (fs *FeedbackServices) DeleteFeedback(feedbackID uint) error <span class="cov8" title="1">{
        err := fs.qry.DeleteFeedback(feedbackID)
        if err != nil </span><span class="cov8" title="1">{
                return errors.New("terjadi kesalahan pada server saat menghapus feedback")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (fs *FeedbackServices) GetFeedbackByID(feedbackID uint) (feedbacks.Feedback, error) <span class="cov8" title="1">{
        feedback, err := fs.qry.GetFeedbackByID(feedbackID)
        if err != nil </span><span class="cov8" title="1">{
                return feedbacks.Feedback{}, errors.New("terjadi kesalahan pada server saat mengambil feedback berdasarkan ID")
        }</span>
        <span class="cov8" title="1">return feedback, nil</span>
}

func (fs *FeedbackServices) GetAllFeedbacks(limit int, offset int) ([]feedbacks.Feedback, int, error) <span class="cov8" title="1">{
        feedbacks, totalItems, err := fs.qry.GetAllFeedbacks(limit, offset)
        if err != nil </span><span class="cov8" title="1">{
                return nil, 0, errors.New("terjadi kesalahan pada server saat mengambil semua feedback")
        }</span>
        <span class="cov8" title="1">return feedbacks, totalItems, nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package service

import (
        "eco_points/internal/features/rewards"
        "eco_points/internal/utils"
        "errors"
        "mime/multipart"
)

type RewardServices struct {
        qry        rewards.RQuery
        cloudinary utils.CloudinaryUtilityInterface
}

func NewRewardService(q rewards.RQuery, c utils.CloudinaryUtilityInterface) rewards.RServices <span class="cov8" title="1">{
        return &amp;RewardServices{
                qry:        q,
                cloudinary: c,
        }
}</span>

func (rs *RewardServices) AddReward(userID uint, newReward rewards.Reward, src multipart.File, filename string) error <span class="cov8" title="1">{
        isAdmin, err := rs.qry.IsAdmin(userID)
        if err != nil || !isAdmin </span><span class="cov8" title="1">{
                return errors.New("forbidden: user is not an admin")
        }</span>

        // Upload image to Cloudinary
        <span class="cov8" title="1">imageURL, err := rs.cloudinary.UploadToCloudinary(src, filename)
        if err != nil </span><span class="cov8" title="1">{
                return errors.New("gagal mengunggah gambar ke cloudinary")
        }</span>
        <span class="cov8" title="1">newReward.Image = imageURL

        err = rs.qry.AddReward(newReward)
        if err != nil </span><span class="cov0" title="0">{
                return errors.New("terjadi kesalahan pada server saat menambahkan reward")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (rs *RewardServices) UpdateReward(userID uint, rewardID uint, updatedReward rewards.Reward, src multipart.File, filename string) error <span class="cov8" title="1">{
        isAdmin, err := rs.qry.IsAdmin(userID)
        if err != nil || !isAdmin </span><span class="cov8" title="1">{
                return errors.New("forbidden: user is not an admin")
        }</span>

        <span class="cov8" title="1">if src != nil </span><span class="cov8" title="1">{
                // Upload image to Cloudinary
                imageURL, err := rs.cloudinary.UploadToCloudinary(src, filename)
                if err != nil </span><span class="cov8" title="1">{
                        return errors.New("failed to upload image to Cloudinary")
                }</span>
                <span class="cov8" title="1">updatedReward.Image = imageURL</span>
        }

        <span class="cov8" title="1">err = rs.qry.UpdateReward(rewardID, updatedReward)
        if err != nil </span><span class="cov0" title="0">{
                return errors.New("server error while updating reward")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (rs *RewardServices) DeleteReward(userID uint, rewardID uint) error <span class="cov8" title="1">{
        isAdmin, err := rs.qry.IsAdmin(userID)
        if err != nil || !isAdmin </span><span class="cov8" title="1">{
                return errors.New("forbidden: user is not an admin")
        }</span>

        <span class="cov8" title="1">err = rs.qry.DeleteReward(rewardID)
        if err != nil </span><span class="cov8" title="1">{
                return errors.New("server error while deleting reward")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

func (rs *RewardServices) GetRewardByID(rewardID uint) (rewards.Reward, error) <span class="cov8" title="1">{
        reward, err := rs.qry.GetRewardByID(rewardID)
        if err != nil </span><span class="cov8" title="1">{
                return rewards.Reward{}, errors.New("terjadi kesalahan pada server saat mengambil data reward")
        }</span>
        <span class="cov8" title="1">return reward, nil</span>
}

func (rs *RewardServices) GetAllRewards(limit int, offset int, search string) ([]rewards.Reward, int, error) <span class="cov8" title="1">{
        rewards, totalItems, err := rs.qry.GetAllRewards(limit, offset, search)
        if err != nil </span><span class="cov8" title="1">{
                return nil, 0, errors.New("terjadi kesalahan pada server saat mengambil semua reward")
        }</span>
        <span class="cov8" title="1">return rewards, totalItems, nil</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package service

import (
        "eco_points/internal/features/users"
        "eco_points/internal/utils"
        "errors"
        "log"
        "mime/multipart"

        "golang.org/x/crypto/bcrypt"
        "gorm.io/gorm"
)

type UserServices struct {
        qry   users.UQuery
        pwd   utils.PassUtilInterface
        jwt   utils.JwtUtilityInterface
        cloud utils.CloudinaryUtilityInterface
}

func NewUserService(q users.UQuery, p utils.PassUtilInterface, j utils.JwtUtilityInterface, c utils.CloudinaryUtilityInterface) users.UService <span class="cov8" title="1">{
        return &amp;UserServices{
                qry:   q,
                pwd:   p,
                jwt:   j,
                cloud: c,
        }
}</span>

func (us *UserServices) Register(newUser users.User) error <span class="cov8" title="1">{

        // hashing password
        hashPw, err := us.pwd.GeneratePassword(newUser.Password)
        if err != nil </span><span class="cov8" title="1">{
                log.Println("register generate password error", err.Error())
                return err
        }</span>
        <span class="cov8" title="1">newUser.IsAdmin = false
        newUser.Password = string(hashPw)
        newUser.Status = "active"

        // register
        err = us.qry.Register(newUser)
        if err != nil </span><span class="cov8" title="1">{
                log.Println("register sql error:", err.Error())
                return errors.New("error in server")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (us *UserServices) Login(email string, password string) (users.User, string, error) <span class="cov8" title="1">{

        result, err := us.qry.Login(email)
        if err != nil </span><span class="cov8" title="1">{
                log.Println("login sql error: ", err.Error())
                return users.User{}, "", errors.New("error in server")
        }</span>

        // cek password
        <span class="cov8" title="1">err = us.pwd.ComparePassword([]byte(result.Password), []byte(password))
        if err != nil </span><span class="cov8" title="1">{
                log.Println("Error On Password", err)
                return users.User{}, "", errors.New(bcrypt.ErrMismatchedHashAndPassword.Error())
        }</span>

        // generete token
        <span class="cov8" title="1">token, err := us.jwt.GenereteJwt(result.ID)
        if err != nil </span><span class="cov8" title="1">{
                log.Println("Error On Jwt ", err)
                return users.User{}, "", errors.New("error on JWT")
        }</span>

        <span class="cov8" title="1">return result, token, nil</span>
}

func (us *UserServices) GetUser(ID uint) (users.User, error) <span class="cov8" title="1">{
        result, err := us.qry.GetUser(ID)

        if err != nil </span><span class="cov8" title="1">{
                if err.Error() == gorm.ErrRecordNotFound.Error() </span><span class="cov8" title="1">{
                        return users.User{}, err
                }</span>
                <span class="cov8" title="1">return users.User{}, errors.New("error in query")</span>
        }

        <span class="cov8" title="1">return result, nil</span>
}

func (us *UserServices) UpdateUser(ID uint, updateUser users.User, file *multipart.FileHeader) error <span class="cov8" title="1">{

        if updateUser.Password != "" </span><span class="cov8" title="1">{
                hashPw, err := us.pwd.GeneratePassword(updateUser.Password)
                if err != nil </span><span class="cov8" title="1">{
                        log.Print("update generete password error", err.Error())
                        return errors.New("update generete password error")
                }</span>
                <span class="cov8" title="1">updateUser.Password = string(hashPw)</span>
        }
        <span class="cov8" title="1">if file != nil </span><span class="cov8" title="1">{
                src, err := us.cloud.FileCheck(file)
                if err != nil </span><span class="cov8" title="1">{
                        return errors.New("file Error")
                }</span>

                <span class="cov8" title="1">urlImage, err := us.cloud.UploadToCloudinary(src, file.Filename)
                if err != nil </span><span class="cov8" title="1">{
                        return errors.New("upload error")
                }</span>
                <span class="cov8" title="1">updateUser.ImgURL = urlImage</span>
        }
        // update user
        <span class="cov8" title="1">err := us.qry.UpdateUser(ID, updateUser)

        if err != nil </span><span class="cov8" title="1">{
                log.Print("update user query error", err.Error())
                return errors.New("query error")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

func (us *UserServices) DeleteUser(ID uint) error <span class="cov8" title="1">{
        err := us.qry.DeleteUser(ID)

        if err != nil </span><span class="cov8" title="1">{
                log.Print("delte user query error", err.Error())
                return errors.New("query error")
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
